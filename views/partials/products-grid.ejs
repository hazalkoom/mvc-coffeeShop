<% if (products && products.length > 0) { %>
    <% products.forEach(product => { %>
        <div class="col-lg-3 col-md-6">
            <div class="product-card">
                <div class="product-image">
                    <img src="<%= product.image_url || '/img/default-product.jpg' %>" 
                         alt="<%= product.product_name %>" 
                         class="img-fluid">
                    <div class="product-overlay">
                        <a href="/products/<%= product.product_id %>" class="btn btn-primary btn-sm">
                            <i class="fas fa-eye me-1"></i>Quick View
                        </a>
                    </div>
                </div>
                <div class="product-info">
                    <div class="product-category">
                        <span class="badge bg-secondary"><%= product.category %></span>
                    </div>
                    <h5 class="product-title">
                        <a href="/products/<%= product.product_id %>"><%= product.product_name %></a>
                    </h5>
                    <p class="product-brand text-muted">by <%= product.brand %></p>
                    
                    <!-- Product Rating -->
                    <div class="product-rating mb-2">
                        <div class="d-flex align-items-center">
                            <div class="rating me-2">
                                <% for (let i = 1; i <= 5; i++) { %>
                                    <% if (i <= Math.floor(product.rating.average)) { %>
                                        <i class="fas fa-star text-warning"></i>
                                    <% } else if (i === Math.ceil(product.rating.average) && product.rating.average % 1 !== 0) { %>
                                        <i class="fas fa-star-half-alt text-warning"></i>
                                    <% } else { %>
                                        <i class="far fa-star text-warning"></i>
                                    <% } %>
                                <% } %>
                            </div>
                            <% if (product.rating.count > 0) { %>
                                <small class="text-muted">(<%= product.rating.count %>)</small>
                            <% } else { %>
                                <small class="text-muted">No reviews</small>
                            <% } %>
                        </div>
                    </div>
                    <div class="product-details">
                        <span class="product-country">
                            <i class="fas fa-map-marker-alt me-1"></i><%= product.country %>
                        </span>
                    </div>
                    <div class="product-price">
                        <span class="price">$<%= parseFloat(product.price).toFixed(2) %></span>
                    </div>
                    <div class="product-actions">
                        <form action="/cart/add" method="post" class="flex-fill">
                            <input type="hidden" name="productId" value="<%= product.product_id %>">
                            <input type="hidden" name="quantity" value="1">
                            <button class="btn btn-primary w-100" type="submit">
                                <i class="fas fa-shopping-cart me-1"></i>Add to Cart
                            </button>
                        </form>
                        <% const isFav = (Array.isArray(typeof favoriteIds !== 'undefined' ? favoriteIds : []) && (favoriteIds || []).includes(String(product.product_id))); %>
                        <button class="btn btn-icon fav-toggle-btn" data-product-id="<%= product.product_id %>" aria-pressed="<%= isFav ? 'true' : 'false' %>">
                            <i class="<%= isFav ? 'fas' : 'far' %> fa-heart"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    <% }) %>
<% } else { %>
    <div class="col-12 text-center">
        <p class="text-muted">No products available at the moment.</p>
    </div>
<% } %>

<script>
document.addEventListener('click', async function(e) {
    const btn = e.target.closest('.fav-toggle-btn');
    if (!btn) return;
    e.preventDefault();
    const productId = btn.getAttribute('data-product-id');
    try {
        const res = await fetch('/favorites/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
            body: JSON.stringify({ productId })
        });
        const data = await res.json();
        if (data && data.ok) {
            const icon = btn.querySelector('i');
            if (data.isFavorite) {
                if (icon) { icon.classList.remove('far'); icon.classList.add('fas'); }
                btn.setAttribute('aria-pressed', 'true');
            } else {
                if (icon) { icon.classList.remove('fas'); icon.classList.add('far'); }
                btn.setAttribute('aria-pressed', 'false');
            }
            if (typeof updateFavCount === 'function') {
                updateFavCount(data.favoritesCount || 0);
            }
        }
    } catch (err) {
        console.error('Favorite toggle failed', err);
        window.location.href = '/login';
    }
});
</script>
